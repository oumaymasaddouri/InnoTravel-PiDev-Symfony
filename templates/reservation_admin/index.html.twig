{% extends 'basebackoffice.html.twig' %}

{% block title %}Reservation Management{% endblock %}

{% block content %}
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Reservation Management</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
                    <li class="breadcrumb-item active">Reservations</li>
                </ol>
            </div>
        </div>
         <div class="row mt-4">
            <div class="col-lg-3 col-6">
                <!-- small box -->
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3>{{ totalReservations }}</h3>
                        <p>Total Reservations</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <a href="#" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <!-- ./col -->
            <div class="col-lg-3 col-6">
                <!-- small box -->
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3>{{ confirmedCount }}</h3>
                        <p>Confirmed</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <a href="#" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <!-- ./col -->
            <div class="col-lg-3 col-6">
                <!-- small box -->
                <div class="small-box bg-warning">
                    <div class="inner">
                        <h3>{{ pendingCount }}</h3>
                        <p>Pending</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <a href="#" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <!-- ./col -->
            <div class="col-lg-3 col-6">
                <!-- small box -->
                <div class="small-box bg-danger">
                    <div class="inner">
                        <h3>{{ cancelledCount }}</h3>
                        <p>Cancelled</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-ban"></i>
                    </div>
                    <a href="#" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
            <!-- ./col -->
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">All Reservations</h3>
                        <div class="card-tools">
                            <form method="get" action="{{ path('app_reservation_admin_index') }}" class="form-inline">
                                <div class="input-group input-group-sm">
                                    <input type="text" name="search" class="form-control" placeholder="Search..." value="{{ app.request.query.get('search') }}">
                                    <div class="input-group-append">
                                        <button type="submit" class="btn btn-default">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="ml-2">
                                    <a href="{{ path('app_reservation_admin_new') }}" class="btn btn-primary btn-sm">
                                        <i class="fas fa-plus"></i> New Reservation
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                    <!-- /.card-header -->
                    <div class="card-body table-responsive p-0">
                        <table class="table table-hover text-nowrap">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Pickup Location</th>
                                    <th>Destination</th>
                                    <th>Price</th>
                                    <th>Status</th>
                                    <th>Created At</th>
                                    <th>Duration</th>
                                    <th>Special Requests</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for reservation in pagination %}
                                <tr>
                                    <td>{{ reservation.id }}</td>
                                    <td>{{ reservation.pickupAddress }}</td>
                                    <td>{{ reservation.destinationAddress }}</td>
                                    <td>
                                        {% if reservation.price %}
                                            <span class="badge bg-info">{{ reservation.price }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Not set</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if reservation.status == 'pending' %}
                                            <span class="badge bg-warning">{{ reservation.status }}</span>
                                        {% elseif reservation.status == 'confirmed' %}
                                            <span class="badge bg-success">{{ reservation.status }}</span>
                                        {% elseif reservation.status == 'cancelled' %}
                                            <span class="badge bg-danger">{{ reservation.status }}</span>
                                        {% else %}
                                            <span class="badge bg-info">{{ reservation.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ reservation.createdAt ? reservation.createdAt|date('Y-m-d H:i') : '' }}</td>
                                    <td>{{ reservation.estimatedDuration }}</td>
                                    <td>
                                        {% if reservation.specialRequests %}
                                            <span class="text-primary">
                                                <i class="fas fa-info-circle"></i> {{ reservation.specialRequests }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">None</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group">
                                            <a href="{{ path('app_reservation_admin_show', {'id': reservation.id}) }}" class="btn btn-info btn-sm" title="View details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{{ path('app_reservation_admin_edit', {'id': reservation.id}) }}" class="btn btn-warning btn-sm" title="Edit reservation">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button" class="btn btn-danger btn-sm" title="Delete" data-toggle="modal" data-target="#delete-modal-{{ reservation.id }}"
                                                {% if (reservation.isActive is defined and not reservation.isActive) %}disabled{% endif %}>
                                                <i class="fas fa-ban"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="9" class="text-center py-5">
                                        <div class="empty-state">
                                            <i class="fas fa-database fa-3x text-muted"></i>
                                            <p class="mt-3">No reservations found in the system.</p>
                                            <a href="{{ path('app_reservation_admin_new') }}" class="btn btn-primary">
                                                <i class="fas fa-plus"></i> Create First Reservation
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <!-- /.card-body -->
                  <!-- Replace the existing pagination with this -->
<div class="card-footer clearfix">
    <ul class="pagination pagination-sm m-0 float-right">
        {% if pagination.page > 1 %}
            <li class="page-item">
                <a class="page-link" href="{{ path('app_reservation_admin_index', app.request.query.all|merge({'page': pagination.page-1})) }}">«</a>
            </li>
        {% else %}
            <li class="page-item disabled">
                <span class="page-link">«</span>
            </li>
        {% endif %}
        
        {% for i in 1..pagination.pageCount %}
            <li class="page-item {% if i == pagination.page %}active{% endif %}">
                <a class="page-link" href="{{ path('app_reservation_admin_index', app.request.query.all|merge({'page': i})) }}">{{ i }}</a>
            </li>
        {% endfor %}
        
        {% if pagination.page < pagination.pageCount %}
            <li class="page-item">
                <a class="page-link" href="{{ path('app_reservation_admin_index', app.request.query.all|merge({'page': pagination.page+1})) }}">»</a>
            </li>
        {% else %}
            <li class="page-item disabled">
                <span class="page-link">»</span>
            </li>
        {% endif %}
    </ul>
</div>
                </div>
                <!-- /.card -->
            </div>
        </div>

        <div class="container-fluid py-4">
    <div class="row mb-2">
        <div class="col-sm-6">
                <h1 class="m-0">Reservation Dashboard</h1>
            </div>
    </div>
    
     <!-- Bar Chart: Top Vehicles by Luggage -->
        <div class="col-lg-8">
            <div class="card shadow-sm rounded-lg">
                <div class="card-header bg-white border-0">
                    <h5 class="card-title mb-0">Status Dashboard</h5>
                </div>
                <div class="card-body">
                    <canvas id="barChart" height="180"></canvas>
                </div>
            </div>
        </div>
</div>
    </div>
</section>

<!-- Delete Modals -->
{% for reservation in pagination %}
    <div class="modal fade" id="delete-modal-{{ reservation.id }}">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger">
                    <h4 class="modal-title">Confirm reservation Deletion</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this reservation record?</p>
                    <p class="text-danger"><small>This action cannot be undone.</small></p>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <form method="post" action="{{ path('app_reservation_admin_delete', {'id': reservation.id}) }}" style="display:inline-block;">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ reservation.id) }}">
                        <button type="submit" class="btn btn-danger">
                            Delete
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endfor %}
{% endblock %}

{% block css %}
    {{ parent() }}
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #FF9F67;
            --dark-color: #263A5B;
            --light-color: #f8f9fa;
            --pending-color: #FFC107;
            --confirmed-color: #4CAF50;
            --cancelled-color: #F44336;
            --border-radius: 12px;
            --card-shadow: 0 8px 20px rgba(0,0,0,0.08);
            --transition: all 0.3s ease;
        }
    </style>
{% endblock %}
{% block js %}
{{ parent() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const colors = [
        'rgba(54, 162, 235, 0.8)', // Blue
        'rgba(75, 192, 192, 0.8)', // Teal
        'rgba(153, 102, 255, 0.8)', // Purple
        'rgba(255, 159, 64, 0.8)',  // Orange
        'rgba(255, 205, 86, 0.8)',  // Yellow
        'rgba(201, 90, 90, 0.8)',   // Darker Red
        'rgba(100, 149, 237, 0.8)', // Cornflower Blue
        'rgba(0, 123, 255, 0.8)',   // Stronger Blue
        'rgba(255, 99, 132, 0.8)'   // Red
   
    ];

    // Bar Chart: Top Vehicles
    const barCtx = document.getElementById('barChart').getContext('2d');
new Chart(barCtx, {
    type: 'bar',
    data: {
        labels: {{ statusStats|map(v => v.status)|json_encode|raw }},
        datasets: [{
            label: 'Reservations by Status',
            data: {{ statusStats|map(v => v.count)|json_encode|raw }},
            backgroundColor: [
                'rgba(75, 192, 192, 0.8)', // Confirmed - green
                'rgba(255, 206, 86, 0.8)',  // Pending - yellow
                'rgba(255, 99, 132, 0.8)'   // Cancelled - red
            ],
            borderColor: [
                'rgba(75, 192, 192, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(255, 99, 132, 1)'
            ],
            borderWidth: 1,
            borderRadius: 5,
            maxBarThickness: 50
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: false },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return `${context.parsed.y} ${context.label.toLowerCase()} reservations`;
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Number of Reservations'
                },
                ticks: {
                    precision: 0,
                    stepSize: 1
                }
            },
            x: {
                title: {
                    display: true,
                    text: 'Reservation Status'
                }
            }
        }
    }
});

});
</script>
{% endblock %}
