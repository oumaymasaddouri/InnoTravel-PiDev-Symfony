{% extends 'basebackoffice.html.twig' %}

{% block title %}Transport Management{% endblock %}

{% block content %}
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-4">
            <div class="col-sm-6">
                <h1 class="m-0">Transport Management</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
                    <li class="breadcrumb-item active">transports</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="info-box bg-gradient-primary">
                    <span class="info-box-icon"><i class="fas fa-taxi"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Total Vehicles</span>
                        <span class="info-box-number">{{ pagination.totalItemCount }}</span>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="info-box bg-gradient-success">
                    <span class="info-box-icon"><i class="fas fa-check-circle"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Active</span>
                        <span class="info-box-number">{{ activeCount ?? '0' }}</span>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="info-box bg-gradient-danger">
                    <span class="info-box-icon"><i class="fas fa-times-circle"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Inactive</span>
                        <span class="info-box-number">{{ inactiveCount ?? '0' }}</span>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="info-box bg-gradient-info">
                    <span class="info-box-icon"><i class="fas fa-suitcase"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Avg. Luggage Capacity</span>
                        <span class="info-box-number">{{ avgLuggageCapacity ?? '0' }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- transport List Card -->
        <div class="row">
            <div class="col-12">
                <div class="card card-outline card-primary">
                    <div class="card-header">
                        <h3 class="card-title">All transports</h3>
                        <div class="card-tools">
                            <form method="get" action="{{ path('app_transport_admin_index') }}" class="form-inline">
                            <div class="input-group input-group-sm" style="width: 250px;">
                                <input type="text" name="search" class="form-control float-right" placeholder="Search transports..." value="{{ app.request.query.get('search') }}">
                                <div class="input-group-append">
                                    <button type="submit" class="btn btn-default">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                                <div class="ml-2 d-inline-block">
                                <a href="{{ path('app_transport_admin_new') }}" class="btn btn-primary btn-sm">
                                    <i class="fas fa-plus"></i> Add transport
                                </a>
                            </div>
                            </div>
                            </form>
                        </div>
                    </div>
                    
                    <div class="card-body table-responsive p-0">
                        <table class="table table-hover text-nowrap table-striped">
                            <thead class="thead-light">
                                <tr>
                                    <th style="width: 60px">ID</th>
                                    <th>Transport Info</th>
                                    <th>Vehicle Details</th>
                                    <th>License Plate</th>
                                    <th>Max Luggage</th>
                                    <th>Status</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for transport in pagination %}
                                <tr>
                                    <td>{{ transport.id }}</td>
                                    <td>
                                        <div class="user-block">
                                            <img class="img-circle elevation-1" src="{{ asset('backoffice/dist/img/avatar5.png') }}" alt="transport">
                                            <span class="username">
                                                <a href="#">{{ transport.user.fullName ?? 'transport #' ~ transport.id }}</a>
                                            </span>
                                            <span class="description">
                                                <i class="fas fa-phone text-primary"></i> {{ transport.user.phoneNumber ?? 'N/A' }}
                                            </span>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary text-sm">{{ transport.carModel }}</span>
                                        <span class="badge ml-1" style="background-color: {{ transport.carColor|lower }}; color: {{ transport.carColor|lower in ['white', 'yellow', 'beige'] ? '#000' : '#fff' }};">
                                            {{ transport.carColor }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-dark">{{ transport.licensePlate }}</span>
                                    </td>
                                    <td>
                                        <div class="progress progress-sm">
                                            {% set maxLuggagePercentage = (transport.maxLuggage / 5) * 100 %}
                                            <div class="progress-bar bg-info" style="width: {{ maxLuggagePercentage }}%"></div>
                                        </div>
                                        <small>{{ transport.maxLuggage }} pieces</small>
                                    </td>
                                    <td>
                                        {% if transport.status is defined %}
                                            {% if transport.status == 'Active' %}
                                                <span class="badge bg-success">Active</span>
                                            {% elseif transport.status == 'Inactive' %}
                                                <span class="badge bg-danger">Inactive</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-danger">Error</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group">
                                            <a href="{{ path('app_transport_admin_show', {'id': transport.id}) }}" class="btn btn-info btn-sm" title="View details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{{ path('app_transport_admin_edit', {'id': transport.id}) }}" class="btn btn-warning btn-sm" title="Edit transport">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button" class="btn btn-danger btn-sm" title="Delete" data-toggle="modal" data-target="#delete-modal-{{ transport.id }}"
                                                {% if (transport.isActive is defined and not transport.isActive) %}disabled{% endif %}>
                                                <i class="fas fa-ban"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="7" class="text-center py-5">
                                        <div class="empty-state">
                                            <i class="fas fa-car-crash fa-4x text-muted mb-3"></i>
                                            <p class="mt-3 text-muted">No transports have been added to the system yet.</p>
                                            <a href="{{ path('app_transport_admin_new') }}" class="btn btn-primary btn-lg mt-3">
                                                <i class="fas fa-plus mr-2"></i> Add First Transport
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="card-footer clearfix bg-light">
                        <ul class="pagination pagination-sm m-0 float-right">
                            {% if pagination.page > 1 %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ path('app_transport_admin_index', app.request.query.all|merge({'page': pagination.page-1})) }}">«</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">«</span>
                                </li>
                            {% endif %}
                            
                            {% for i in 1..pagination.pageCount %}
                                <li class="page-item {% if i == pagination.page %}active{% endif %}">
                                    <a class="page-link" href="{{ path('app_transport_admin_index', app.request.query.all|merge({'page': i})) }}">{{ i }}</a>
                                </li>
                            {% endfor %}
                            
                            {% if pagination.page < pagination.pageCount %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ path('app_transport_admin_index', app.request.query.all|merge({'page': pagination.page+1})) }}">»</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">»</span>
                                </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="callout callout-info">
                    <h5><i class="fas fa-info-circle"></i> Transport Analytics Dashboard</h5>
                    <p class="mb-0">View key metrics and analytics about your transport fleet below.</p>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <!-- Bar Chart: Top Vehicles by Luggage -->
            <div class="col-lg-8">
                <div class="card shadow-sm rounded-lg">
                    <div class="card-header bg-white border-0">
                        <h5 class="card-title mb-0"><i class="fas fa-chart-bar mr-2 text-primary"></i>Top Vehicles by Luggage Capacity</h5>
                    </div>
                    <div class="card-body px-4">
                        <canvas id="barChart" height="200"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Pie Chart: Car Color Distribution -->
            <div class="col-lg-4">
                <div class="card shadow-sm rounded-lg">
                    <div class="card-header bg-white border-0">
                        <h5 class="card-title mb-0"><i class="fas fa-palette mr-2 text-primary"></i>Car Color Distribution</h5>
                    </div>
                    <div class="card-body px-4">
                        <canvas id="pieChart" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Delete Modals -->
{% for transport in transports %}
    <div class="modal fade" id="delete-modal-{{ transport.id }}">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger">
                    <h4 class="modal-title">Confirm Transport Deletion</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-exclamation-triangle text-warning fa-2x mr-3"></i>
                        <div>
                            <p class="mb-1">Are you sure you want to delete this transport record?</p>
                            <p class="text-danger mb-0"><small>This action cannot be undone.</small></p>
                        </div>
                    </div>
                    <div class="alert alert-warning">
                        <strong>Transport ID:</strong> #{{ transport.id }}<br>
                        <strong>Vehicle:</strong> {{ transport.carModel }} ({{ transport.carColor }})
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <form method="post" action="{{ path('app_transport_admin_delete', {'id': transport.id}) }}" style="display:inline-block;">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ transport.id) }}">
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash mr-1"></i> Delete
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endfor %}
{% endblock %}


{% block css %}
    {{ parent() }}
    <style>
    /* Base styling */
    body {
        font-family: 'Poppins', 'Segoe UI', Roboto, sans-serif;
    }

    /* Page header styling */
    .content-header {
        padding: 15px 0;
    }

    h1 {
        font-weight: 700;
        background: linear-gradient(45deg, #344767, #4b6cb7);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 0.5rem;
        font-size: 2.2rem;
    }

    /* Card styling */
    .card {
        transition: all 0.3s ease;
        border: none;
        border-radius: 0.75rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        overflow: hidden;
        margin-bottom: 1.5rem;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }

    .card-outline.card-primary {
        border-top: 3px solid #4b6cb7;
    }

    .card-header {
        padding: 1.25rem 1.5rem;
        background: #fff;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .card-title {
        color: #344767;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
    }

    .card-body {
        padding: 1.25rem;
    }

    /* Table styling */
    .table {
        margin-bottom: 0;
    }

    .table thead th {
        background-color: #f8f9fa;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
        padding: 0.75rem 1rem;
        border-bottom: 2px solid #dee2e6;
    }

    .table tbody td {
        padding: 1rem;
        vertical-align: middle;
        border-color: #f2f2f2;
    }

    /* Info boxes */
    .info-box {
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        border-radius: 0.75rem;
        height: 100%;
    }

    .info-box-icon {
        border-radius: 0.75rem 0 0 0.75rem;
        width: 80px;
        font-size: 1.5rem;
    }

    .bg-gradient-primary {
        background: linear-gradient(45deg, #4b6cb7, #182848);
        color: white;
    }

    .bg-gradient-success {
        background: linear-gradient(45deg, #28a745, #1e7e34);
        color: white;
    }

    .bg-gradient-danger {
        background: linear-gradient(45deg, #dc3545, #bd2130);
        color: white;
    }

    .bg-gradient-info {
        background: linear-gradient(45deg, #17a2b8, #117a8b);
        color: white;
    }

    /* Badge styling */
    .badge {
        padding: 0.5em 0.75em;
        font-weight: 500;
        border-radius: 0.375rem;
    }

    /* Progress bar */
    .progress {
        height: 6px;
        border-radius: 3px;
        background-color: #f0f0f0;
        margin: 5px 0;
    }

    /* Button styling */
    .btn {
        border-radius: 0.5rem;
        padding: 0.375rem 0.75rem;
        font-weight: 500;
        transition: all 0.2s;
    }

    .btn-group .btn {
        border-radius: 0.375rem;
        box-shadow: none;
        margin: 0 2px;
    }

    .btn-primary {
        background: #4b6cb7;
        border-color: #4b6cb7;
    }

    .btn-primary:hover {
        background: #3c5aa5;
        border-color: #3c5aa5;
    }

    /* Callout styling */
    .callout {
        border-radius: 0.5rem;
        border-left: 5px solid #4b6cb7;
    }

    /* Empty state styling */
    .empty-state {
        padding: 2rem;
        text-align: center;
    }

    /* Pagination styling */
    .pagination .page-link {
        border-radius: 0.25rem;
        margin: 0 2px;
        color: #4b6cb7;
    }

    .pagination .page-item.active .page-link {
        background-color: #4b6cb7;
        border-color: #4b6cb7;
    }

    /* User block */
    .user-block img {
        width: 40px;
        height: 40px;
        object-fit: cover;
    }

    .user-block .username {
        font-weight: 600;
    }

    .user-block .description {
        color: #6c757d;
    }
    </style>
{% endblock %}


{% block js %}
{{ parent() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Modern color palette
    const colors = [
        'rgba(59, 130, 246, 0.8)',  // Blue
        'rgba(16, 185, 129, 0.8)',  // Green
        'rgba(139, 92, 246, 0.8)',  // Purple
        'rgba(249, 115, 22, 0.8)',  // Orange
        'rgba(234, 179, 8, 0.8)',   // Yellow
        'rgba(239, 68, 68, 0.8)',   // Red
        'rgba(14, 165, 233, 0.8)',  // Light Blue
        'rgba(79, 70, 229, 0.8)',   // Indigo
        'rgba(236, 72, 153, 0.8)'   // Pink
    ];

    // Bar Chart: Top Vehicles with improved aesthetics
    const barCtx = document.getElementById('barChart').getContext('2d');
    new Chart(barCtx, {
        type: 'bar',
        data: {
            labels: {{ topVehicles|map(v => v.getCarModel())|json_encode|raw }},
            datasets: [{
                label: 'Luggage Capacity (kg)',
                data: {{ topVehicles|map(v => v.getMaxLuggage())|json_encode|raw }},
                backgroundColor: colors,
                borderColor: colors.map(c => c.replace('0.8', '1')),
                borderWidth: 1,
                borderRadius: 8,
                maxBarThickness: 60
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    bodyFont: { size: 14 },
                    titleFont: { size: 16 },
                    padding: 12,
                    cornerRadius: 6
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        font: { size: 12 }
                    },
                    title: {
                        display: true,
                        text: 'Capacity (kg)',
                        font: { size: 14, weight: 'bold' }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: { size: 12 }
                    }
                }
            },
            animation: {
                duration: 2000,
                easing: 'easeOutQuart'
            }
        }
    });

    // Pie Chart: Car Color Distribution with improved aesthetics
    const pieCtx = document.getElementById('pieChart').getContext('2d');
    new Chart(pieCtx, {
        type: 'doughnut',
        data: {
            labels: {{ colorLabels|json_encode|raw }},
            datasets: [{
                data: {{ colorData|json_encode|raw }},
                backgroundColor: colors,
                borderColor: '#ffffff',
                borderWidth: 2,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        font: { size: 12 }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    bodyFont: { size: 14 },
                    titleFont: { size: 16 },
                    padding: 12,
                    cornerRadius: 6,
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const value = context.raw;
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${context.label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            },
            cutout: '65%',
            animation: {
                animateScale: true,
                animateRotate: true,
                duration: 2000,
                easing: 'easeOutQuart'
            }
        }
    });
});
</script>
{% endblock %}